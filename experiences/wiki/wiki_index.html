<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inscryption Campaign Wiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="wiki_style.css">
</head>
<body>
<header>
  <h1>Inscryption Disk 3 Wiki</h1>
  <div class="search-container">
    <input type="text" id="searchbar" placeholder="Search..." autocomplete="off">
    <ul id="search-results"></ul>
    <script>
      // Holds the wiki data loaded from wikidata.json
      let wikidata = {};

      // Fetch the wiki data JSON
      fetch("wikidata.json")
        .then(r => r.json())
        .then(data => {
          wikidata = data;
        });

      const searchInput = document.getElementById("searchbar");
      const resultsList = document.getElementById("search-results");

      searchInput.addEventListener("input", () => {
        updateResults();
      });

      searchInput.addEventListener("focus", () => {
        updateResults();
      });

      document.addEventListener("click", (e) => {
        if (!searchInput.contains(e.target) && !resultsList.contains(e.target)) {
          resultsList.style.display = "none";
        }
      });

      function updateResults() {
        const query = searchInput.value.toLowerCase().trim();
        resultsList.innerHTML = "";

        const matches = [];

        for (const [page, info] of Object.entries(wikidata)) {
          // Articles
          if (info.title.toLowerCase().includes(query)) {
            matches.push({ type: "article", key: page, label: info.title });
          }
          // Categories
          if (info.categories) {
            for (const c of info.categories) {
              if (c.toLowerCase().includes(query) && !matches.some(m => m.type === "category" && m.label === "Category:"+c)) {
                matches.push({ type: "category", key: c, label: "Category:"+c });
              }
            }
          }
        }

        if (matches.length === 0) {
          resultsList.style.display = "none";
          return;
        }

        resultsList.style.display = "block";

        // Up to 10 results
        for (const m of matches.slice(0, 10)) {
          const li = document.createElement("li");
          li.textContent = m.label;

          li.addEventListener("click", () => {
            if (m.type === "article") {
              window.location.href = `wiki_index.html?page=${m.key}`;
            } else if (m.type === "category") {
              window.location.href = `wiki_index.html?page=categories&${encodeURIComponent(m.key)}`;
            }
          });

          resultsList.appendChild(li);
        }
      }
    </script>
  </div>
  <nav>
    <a href="wiki_index.html">Home</a>
    <a href="wiki_index.html?page=articles">Articles</a>
    <a href="wiki_index.html?page=categories">Categories</a>
  </nav>
</header>

<div class="container">
  <div class="sidebar">
    <aside>
      <h3>Navigation</h3>
      <ul>
        <li><a href="wiki_index.html?page=game">Game</a></li>
        <li><a href="wiki_index.html?page=story">Main Story</a></li>
        <li><a href="wiki_index.html?page=temples">Temples</a></li>
        <li><a href="wiki_index.html?page=characters">Characters</a></li>
        <li><a href="wiki_index.html?page=categories&Events">Events</a></li>
      </ul>

      <h3>Extras</h3>
      <ul>
        <li><a href="wiki_index.html?page=article-exemple">Example Article</a></li>
        <li><a href="https://blakeline-was-taken.github.io/card-storage/">Other Experiences</a></li>
        <li><a href="https://blakeline-was-taken.github.io/card-storage/">Github Repository</a></li>
      </ul>
    </aside>
  </div>

  <main id="page-content">
    <script>
      const params = new URLSearchParams(window.location.search);
      const page = params.get("page") || "home";

      fetch("wikidata.json")
        .then(r => r.json())
        .then(data => {
          let bannerHtml = "";
          if (data[page]) {
            if (data[page].categories && data[page].categories.length > 0) {
              bannerHtml = `<div class="page-banner"> in: ${data[page].categories.map(c => `<a href="wiki_index.html?page=categories&${c}">${c}</a>`).join(", ")} </div>`;
            }
          }

          return fetch(`pages/${page}.html`)
            .then(r => {
              if (r.ok) {
                return r.text().then(html => {
                  document.getElementById("page-content").innerHTML = bannerHtml + html;
                  // Replace <card> elements with actual cards
                  const cardNodes = document.getElementById("page-content").querySelectorAll("card[page]");
                  cardNodes.forEach(node => {
                    const key = node.getAttribute("page");
                    const article = data[key];
                    if (article) {
                      const card = document.createElement("a");
                      card.className = "card";
                      card.href = `wiki_index.html?page=${key}`;
                      card.innerHTML = `
                        ${article.image ? `<img src="${article.image}" alt="${article.title}">` : ""}
                        <h4>${article.title}</h4>
                        <p>${article.description || ""}</p>
                      `;
                      node.replaceWith(card);
                    } else {
                      node.replaceWith(document.createTextNode(`[Unknown page: ${key}]`));
                    }
                  });
                });
              }
              else if (r.status === 404) {
                return import(`./pages/${page}.js`)
                  .then(module => {
                    if (module && typeof module.default === "function") {
                      module.default(document.getElementById("page-content"), bannerHtml);
                    } else {
                      document.getElementById("page-content").innerHTML = `<p>Error: JS module loaded but default export is not a function</p>`;
                    }
                  })
                  .catch(jsErr => {
                    if (jsErr && jsErr.message && jsErr.message.includes("Failed to fetch dynamically imported module")) {
                      document.getElementById("page-content").innerHTML = `<p>This page does not seem to exist.</p>`;
                    } else {
                      document.getElementById("page-content").innerHTML = `<p>Error: ${jsErr}</p>`;
                    }
                  });
              }
              else {
                return Promise.reject(`HTTP error ${r.status}`);
              }
            });
        })
        .catch(err => {
          document.getElementById("page-content").innerHTML = `<p>Error : ${err}</p>`;
        });
    </script>
  </main>
</div>
</body>
</html>
